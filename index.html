<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üå± Grow A Garden Live Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/2a4b4e8b0a.js" crossorigin="anonymous"></script>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2909/2909591.png" />
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#22c55e" />
  <style>
    .glass {
      background: rgba(31, 41, 55, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .fa-spin-once {
      animation: spinOnce 0.8s linear;
    }
    @keyframes spinOnce {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    #install-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #22c55e;
      color: white;
      padding: 12px 18px;
      border-radius: 9999px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      font-weight: bold;
      z-index: 50;
      cursor: pointer;
      user-select: none;
      display: block;
      transition: background-color 0.3s ease;
    }
    #install-btn:hover {
      background: #16a34a;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white min-h-screen font-sans relative">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <header class="flex items-center justify-between mb-10">
      <h1 class="text-4xl font-extrabold flex items-center gap-3 text-green-400 drop-shadow">
        <i class="fas fa-seedling"></i> Grow A Garden Live Dashboard
      </h1>
      <div>
        <button id="refresh-btn" class="bg-gray-700 hover:bg-green-500 hover:text-white px-4 py-2 rounded-lg transition-all duration-300 shadow-md">
          <i class="fas fa-sync-alt text-xl"></i>
        </button>
      </div>
    </header>
    <main id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
      <!-- Cards rendered here -->
    </main>

    <footer class="mt-12 text-center text-sm text-gray-400">
      Last updated: <time id="last-updated">‚Äî</time>
    </footer>
  </div>

  <!-- Install Button -->
  <button id="install-btn" title="Install this app">
    <i class="fas fa-download mr-2"></i> Install App
  </button>

  <script>
    const refreshBtn = document.getElementById('refresh-btn');
    const dashboard = document.getElementById('dashboard');
    const updatedTime = document.getElementById('last-updated');
    const installBtn = document.getElementById('install-btn');

    let socket;
    let deferredPrompt;
    let reconnectInterval = 5000; // 5s to start reconnect
    let maxReconnectInterval = 60000; // max 1 min reconnect
    let reconnectAttempts = 0;

    // -------- PWA Install Prompt --------
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          console.log("‚úÖ App installed");
          installBtn.style.display = 'none';
        }
        deferredPrompt = null;
      } else {
        alert("Install prompt not available. Your browser may not support it or the app is already installed.");
      }
    });

    // -------- Notification Permission --------
    async function requestNotificationPermission() {
      if (!('Notification' in window)) {
        console.warn("Notifications not supported");
        return false;
      }
      if (Notification.permission === 'granted') return true;
      if (Notification.permission === 'denied') return false;
      const permission = await Notification.requestPermission();
      return permission === 'granted';
    }

    // -------- Push Subscription --------
    async function subscribeUserToPush() {
      if (!('serviceWorker' in navigator)) return null;
      if (!('PushManager' in window)) return null;

      const registration = await navigator.serviceWorker.ready;

      // TODO: Replace with your own public VAPID key (URL-safe base64)
      const vapidPublicKey = 'BJInWT3YugUZg06VHuIBwiM9AqM2vfXFaHjk6QJngnp3m05QfVVGLxX7Hp8aZtpm0rICBJe8r9od4rjH_ZUIdGE';

      // Convert base64 to Uint8Array for subscription options
      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
        const rawData = atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      }

      try {
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
        });
        console.log('Push Subscription:', subscription);

        // Send subscription to your server to save for push messages
        // Example:
        // await fetch('/subscribe', {
        //   method: 'POST',
        //   body: JSON.stringify(subscription),
        //   headers: {'Content-Type': 'application/json'}
        // });

        return subscription;
      } catch (err) {
        console.error('Failed to subscribe user to push', err);
        return null;
      }
    }

    // -------- Show Notification --------
    function notifyUser(title, options) {
      if ('Notification' in window && Notification.permission === 'granted') {
        // Prefer using Service Worker notifications for background
        if (navigator.serviceWorker && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({
            type: 'show-notification',
            title,
            options
          });
        } else {
          new Notification(title, options);
        }
      }
    }

    // -------- WebSocket Connect + Reconnect --------
    function connectWebSocket() {
      socket = new WebSocket("wss://gagstock.gleeze.com");

      socket.onopen = () => {
        console.log("‚úÖ Connected to WebSocket");
        reconnectAttempts = 0;
        refreshBtn.classList.add("fa-spin-once");
        setTimeout(() => refreshBtn.classList.remove("fa-spin-once"), 800);
      };

      socket.onmessage = (event) => {
        try {
          const json = JSON.parse(event.data);
          renderDashboard(json.data);
          updatedTime.textContent = new Date(json.updated_at).toLocaleString("en-PH", { timeZone: "Asia/Manila" });

          // Notify user of new update
          notifyUser('Grow A Garden Update', {
            body: `Dashboard updated at ${updatedTime.textContent}`,
            icon: 'https://cdn-icons-png.flaticon.com/512/2909/2909591.png'
          });

        } catch (err) {
          console.error("‚ùå Invalid data from WebSocket:", err);
        }
      };

      socket.onerror = (err) => {
        console.error("WebSocket error:", err);
      };

      socket.onclose = () => {
        console.warn("üîå WebSocket closed. Attempting reconnect...");
        reconnectAttempts++;
        let timeout = Math.min(reconnectInterval * reconnectAttempts, maxReconnectInterval);
        setTimeout(connectWebSocket, timeout);
      };
    }

    // -------- Render Dashboard --------
    function renderDashboard(data) {
      dashboard.innerHTML = '';
      Object.entries(data).forEach(([key, value]) => {
        if (key === 'updated_at') return;
        const card = document.createElement('div');
        card.className = "glass p-5 rounded-xl shadow-lg transform transition hover:scale-[1.03] hover:shadow-2xl";
        card.innerHTML = `
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold capitalize">
              <i class="fas fa-box-open mr-2 text-green-400"></i>${key}
            </h2>
            <span class="text-sm text-gray-300">${value.countdown || ''}</span>
          </div>
          <ul class="space-y-2">
            ${value.items.map(item => `
              <li class="flex items-center gap-3 p-2 rounded-lg bg-gray-800 hover:bg-gray-700 transition">
                ${item.image
                  ? `<img src="${item.image}" class="w-8 h-8 rounded-full object-cover" />`
                  : `<span class="text-2xl">${item.emoji || '‚ùì'}</span>`}
                <div class="flex-1">
                  <p class="font-medium">${item.name}</p>
                </div>
                <span class="text-sm text-green-300 font-mono">${item.quantity}</span>
              </li>
            `).join('')}
          </ul>
        `;
        dashboard.appendChild(card);
      });
    }

    refreshBtn.addEventListener('click', () => {
      if (socket && socket.readyState === WebSocket.OPEN) {
        refreshBtn.classList.add("fa-spin-once");
        setTimeout(() => refreshBtn.classList.remove("fa-spin-once"), 800);
      } else {
        alert("WebSocket not connected. Trying to reconnect...");
        connectWebSocket();
      }
    });

    // -------- Register Service Worker and Push --------
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
      .then(async (registration) => {
        console.log('Service Worker Registered', registration);

        const permissionGranted = await requestNotificationPermission();
        if (permissionGranted) {
          await subscribeUserToPush();
        }
      })
      .catch(console.error);
    }

    // -------- Listen for messages from Service Worker --------
    navigator.serviceWorker.addEventListener('message', event => {
      if (event.data && event.data.type === 'notification-click') {
        // Handle notification click if needed
        console.log('Notification clicked!');
      }
    });

    // -------- Start WebSocket --------
    connectWebSocket();

  </script>
</body>
</html>
